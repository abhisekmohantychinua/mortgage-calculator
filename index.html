<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mortgage Calculator | Get the right mortgage for you</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/intl-tel-input@25.12.3/build/css/intlTelInput.css"
    />
    <style>
      :root {
        --bg: #ffffff;
        --text: #262626;
        --primary: #6d28d9;
        --primary-200: rgba(109, 40, 217, 0.15);
        --primary-300: #e9d5ff;
        --border: #e5e7eb;
        --muted: #6b7280;
        --danger: #ef4444;
        --radius: 12px;
      }

      /* Page base */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      html,
      body {
        max-width: 100%;
        overflow-x: hidden;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        color: var(--text);
        background: var(--bg);
        line-height: 1.45;
        margin: 0;
      }
      h1 {
        text-align: center;
        font-weight: 800;
        margin: 28px 0 18px;
        color: #111827;
      }

      /* Layout */
      .mgc-container {
        max-width: 1180px;
        margin: 0 auto;
        padding: 0 24px 48px;
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 40px;
        align-items: start;
      }
      .mgc-form-section,
      .mgc-result-section {
        min-width: 0;
      }
      .mgc-form-section .mgc-field {
        margin-bottom: 24px;
      }
      .mgc-field label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
      }
      .mgc-result-section {
        position: sticky;
        top: 32px;
      }

      /* Input group with suffix/prefix */
      .mgc-input-group {
        position: relative;
      }
      .mgc-text-input {
        width: 100%;
        padding: 12px 14px;
        padding-right: 64px; /* space for suffix */
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
      }
      .mgc-text-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-200);
      }
      .mgc-suffix,
      .mgc-prefix {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        color: var(--muted);
        pointer-events: none;
      }
      .mgc-suffix {
        right: 12px;
      }
      .mgc-prefix {
        left: 12px;
      }
      .mgc-text-input.mgc-with-prefix {
        padding-left: 60px;
      }

      /* Sliders */
      .mgc-container input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: #e9e5f4;
        outline: none;
      }
      .mgc-container input[type="range"]:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-200);
        border-radius: 999px;
      }
      .mgc-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: var(--primary);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 0 3px #f4ecff;
      }
      .mgc-container input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: var(--primary);
        border-radius: 50%;
        border: none;
        cursor: pointer;
      }
      /* Filled track visualization painted via JS */
      .mgc-container input[type="range"] {
        background-image: linear-gradient(
          to right,
          var(--primary) 0%,
          var(--primary) 0%,
          #e9e5f4 0%,
          #e9e5f4 100%
        );
      }
      .mgc-range-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
        gap: 8px;
      }
      .mgc-range-labels span {
        min-width: 0;
        word-break: break-word;
      }

      /* Residency segmented */
      .mgc-residency {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }
      .mgc-residency button {
        padding: 12px 10px;
        border: none;
        background: #fafafa;
        color: #374151;
        cursor: pointer;
        border-right: 1px solid var(--border);
        font-weight: 500;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      }
      .mgc-residency button:last-child {
        border-right: none;
      }
      .mgc-residency button.active {
        background: var(--primary-200);
        color: var(--primary);
        box-shadow: inset 0 0 0 2px var(--primary);
      }

      /* Result card */
      .mgc-result {
        background: #fff;
        border: 1px solid var(--border);
        padding: 28px;
        border-radius: var(--radius);
      }
      .mgc-result h3 {
        margin: 0 0 16px;
        font-size: 18px;
        color: #111827;
        font-weight: 600;
      }
      .mgc-kpis {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        align-items: end;
      }
      .mgc-kpi {
        text-align: center;
      }
      .mgc-kpi small {
        display: block;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .mgc-kpi .mgc-num {
        font-size: 30px;
        font-weight: 800;
        color: #4b0082;
      }
      .mgc-actions {
        display: flex;
        justify-content: center;
        margin: 14px 0 8px;
      }
      .mgc-btn-ghost {
        border: 1px solid var(--primary-300);
        color: var(--primary);
        background: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease,
          border-color 0.15s ease;
      }
      .mgc-btn-ghost:hover {
        background: var(--primary-200);
      }
      .mgc-hr {
        height: 1px;
        background: var(--border);
        margin: 18px 0;
      }

      /* Details form */
      .mgc-details h3 {
        font-size: 18px;
        margin: 0 0 12px;
        color: #111827;
      }
      .mgc-details .mgc-text-input {
        margin-bottom: 12px;
      }
      .mgc-btn {
        width: 100%;
        padding: 14px;
        background: var(--danger);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 700;
      }
      .mgc-btn:hover {
        filter: brightness(0.95);
      }
      .mgc-btn-outline {
        border: 1px solid var(--primary-300);
        background: #fff;
        color: var(--primary);
        padding: 10px 14px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease,
          border-color 0.15s ease;
      }
      .mgc-btn-outline:hover {
        background: var(--primary-200);
      }
      .mgc-note-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .mgc-small-note {
        font-size: 14px;
        color: var(--muted);
      }

      /* Fallback phone UI (when CDN blocked) */
      .mgc-phone-wrap {
        display: flex;
        gap: 8px;
        align-items: stretch;
      }
      .mgc-dial-select {
        min-width: 120px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #fff;
        font-size: 14px;
      }
      .mgc-dial-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-200);
      }

      /* Intl Tel Input adjustments */
      .iti {
        width: 100%;
      }
      .iti__country-list {
        z-index: 60;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      .iti--separate-dial-code .iti__selected-dial-code {
        font-weight: 600;
        color: #111827;
      }
      .iti--separate-dial-code .iti__selected-flag {
        background: #fff;
        border: 1px solid var(--border);
        border-right: none;
        border-radius: 8px 0 0 8px;
        padding: 0 10px;
      }
      .iti--separate-dial-code input[type="tel"].mgc-text-input {
        border-radius: 0 8px 8px 0;
      }
      .iti__selected-flag:hover {
        background: #fafafa;
      }

      /* Modal */
      .mgc-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(17, 24, 39, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 50;
      }
      .mgc-modal-overlay.open {
        display: flex;
      }
      .mgc-modal {
        width: 100%;
        max-width: 680px;
        background: #fff;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      .mgc-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
      }
      .mgc-modal-title {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
      }
      .mgc-modal-close {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #6b7280;
      }
      .mgc-modal-body {
        padding: 16px 20px 6px;
      }
      .mgc-table {
        display: grid;
        gap: 10px;
      }
      .mgc-table-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
      }
      .mgc-table-row + .mgc-table-row {
        border-top: 1px dashed var(--border);
      }
      .mgc-row-label {
        color: #374151;
        font-weight: 500;
      }
      .mgc-row-value {
        color: #111827;
        font-weight: 700;
      }
      .mgc-accordion {
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 8px;
      }
      .mgc-accordion-header {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        background: #fafafa;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: #111827;
      }
      .mgc-accordion-chevron {
        transition: transform 0.2s ease;
        color: #6b7280;
      }
      .mgc-accordion.open .mgc-accordion-chevron {
        transform: rotate(180deg);
      }
      .mgc-accordion-value {
        font-weight: 700;
        color: #111827;
      }
      .mgc-accordion-body {
        display: none;
        padding: 8px 14px 14px;
        background: #fff;
      }
      .mgc-accordion.open .mgc-accordion-body {
        display: block;
      }
      .mgc-fees-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .mgc-fees-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed var(--border);
      }
      .mgc-fees-list li:last-child {
        border-bottom: none;
      }
      .mgc-modal-footer {
        padding: 16px 20px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      @media (max-width: 1024px) {
        .mgc-container {
          grid-template-columns: 1fr;
          gap: 28px;
          padding: 0 16px 40px;
        }
        .mgc-result-section {
          position: static;
        }
        h1 {
          font-size: 28px;
        }
        .mgc-kpis {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <h1>Get the right mortgage for you</h1>

    <div class="mgc-container">
      <div class="mgc-form-section">
        <!-- Purchase Price -->
        <div class="mgc-field">
          <label>Purchase Price</label>
          <div class="mgc-input-group">
            <input
              type="text"
              id="mgc-purchasePriceInput"
              class="mgc-text-input"
              value="1,200,000"
            />
            <span class="mgc-suffix">AED</span>
          </div>
          <input
            type="range"
            id="mgc-purchasePrice"
            min="300000"
            max="200000000"
            step="10000"
            value="1200000"
          />
          <div class="mgc-range-labels">
            <span id="mgc-purchaseMinLabel">300,000 AED</span>
            <span id="mgc-purchaseMaxLabel">200,000,000 AED</span>
          </div>
        </div>

        <!-- Residency Status -->
        <div class="mgc-field">
          <label>Residency Status</label>
          <div class="mgc-residency">
            <button id="mgc-uaeNational">UAE national</button>
            <button id="mgc-uaeResident" class="active">UAE resident</button>
            <button id="mgc-nonResident">Non resident</button>
          </div>
        </div>

        <!-- Down Payment -->
        <div class="mgc-field">
          <label>Down payment</label>
          <div class="mgc-input-group">
            <input
              type="text"
              id="mgc-downPaymentInput"
              class="mgc-text-input"
              value="240,000"
            />
            <span class="mgc-suffix"
              ><span id="mgc-downPercent">20</span>%</span
            >
          </div>
          <input
            type="range"
            id="mgc-downPayment"
            min="0"
            max="1200000"
            step="10000"
            value="240000"
          />
          <div class="mgc-range-labels">
            <span id="mgc-downMinLabel">0 AED</span>
            <span id="mgc-downMaxLabel">1,200,000 AED</span>
          </div>
        </div>

        <!-- Loan Amount -->
        <div class="mgc-field">
          <label>Loan amount</label>
          <div class="mgc-input-group">
            <input
              type="text"
              id="mgc-loanAmountInput"
              class="mgc-text-input"
              value="960,000"
            />
            <span class="mgc-suffix"
              ><span id="mgc-loanPercent">80</span>%</span
            >
          </div>
          <input
            type="range"
            id="mgc-loanAmount"
            min="0"
            max="1200000"
            step="10000"
            value="960000"
          />
          <div class="mgc-range-labels">
            <span id="mgc-loanMinLabel">0 AED</span>
            <span id="mgc-loanMaxLabel">1,200,000 AED</span>
          </div>
        </div>

        <!-- Loan Period -->
        <div class="mgc-field">
          <label>Loan Period</label>
          <div class="mgc-input-group">
            <input
              type="text"
              id="mgc-loanPeriodInput"
              class="mgc-text-input"
              value="25"
            />
            <span class="mgc-suffix">years</span>
          </div>
          <input type="range" id="mgc-loanPeriod" min="1" max="25" value="25" />
          <div class="mgc-range-labels">
            <span>1 year</span>
            <span>25 years</span>
          </div>
        </div>

        <!-- Interest Rate -->
        <div class="mgc-field">
          <label>Interest rate</label>
          <div class="mgc-input-group">
            <input
              type="text"
              id="mgc-interestRateInput"
              class="mgc-text-input"
              value="3.75"
            />
            <span class="mgc-suffix">%</span>
          </div>
          <input
            type="range"
            id="mgc-interestRate"
            min="1"
            max="10"
            step="0.01"
            value="3.75"
          />
          <div class="mgc-range-labels">
            <span>1%</span>
            <span>10%</span>
          </div>
        </div>
      </div>

      <div class="mgc-result-section">
        <div class="mgc-result">
          <h3>Estimate your monthly mortgage payment</h3>
          <div class="mgc-kpis">
            <div class="mgc-kpi">
              <small>monthly payment</small>
              <div class="mgc-num" id="mgc-monthlyPayment">4,936 AED</div>
            </div>
            <div class="mgc-kpi">
              <small>with interest rate of</small>
              <div class="mgc-num" id="mgc-rateDisplay">3.75%</div>
            </div>
          </div>
          <div class="mgc-actions">
            <button id="mgc-viewCostsBtn" class="mgc-btn-ghost" type="button">
              View upfront costs
            </button>
          </div>
          <div class="mgc-hr"></div>
          <form id="mgc-form" class="mgc-details">
            <h3>Please enter your details</h3>
            <input
              type="text"
              id="mgc-name"
              class="mgc-text-input"
              placeholder="Enter your name"
            />
            <input
              type="email"
              id="mgc-email"
              class="mgc-text-input"
              placeholder="Enter your email address"
            />
            <input
              id="mgc-phone"
              type="tel"
              class="mgc-text-input"
              autocomplete="tel"
              placeholder="Enter your phone number"
            />
            <button class="mgc-btn" type="submit">
              Check your eligibility
            </button>
            <div class="mgc-note-row">
              <div class="mgc-small-note">
                We found <strong>51,937 properties</strong> within your budget.
              </div>
              <button class="mgc-btn-outline" type="button">
                View properties →
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Upfront Costs Modal -->
    <div
      id="mgc-costsModal"
      class="mgc-modal-overlay"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="mgc-modal" role="document">
        <div class="mgc-modal-header">
          <div class="mgc-modal-title">Upfront costs breakdown</div>
          <button
            class="mgc-modal-close"
            id="mgc-closeCostsBtn"
            aria-label="Close"
          >
            ×
          </button>
        </div>
        <div class="mgc-modal-body">
          <div class="mgc-table">
            <div class="mgc-table-row">
              <div class="mgc-row-label">Down payment</div>
              <div class="mgc-row-value" id="mgc-dpRowValue">0 AED</div>
            </div>
          </div>

          <div id="mgc-costsAccordion" class="mgc-accordion open">
            <button class="mgc-accordion-header" type="button">
              <div style="display: flex; gap: 8px; align-items: center">
                <svg
                  class="mgc-accordion-chevron"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M11.6464 9.64645C11.8417 9.45118 12.1583 9.45118 12.3536 9.64645L15.3536 12.6464C15.5488 12.8417 15.5488 13.1583 15.3536 13.3536C15.1583 13.5488 14.8417 13.5488 14.6464 13.3536L12 10.7071L9.35355 13.3536C9.15829 13.5488 8.84171 13.5488 8.64645 13.3536C8.45118 13.1583 8.45118 12.8417 8.64645 12.6464L11.6464 9.64645Z"
                    fill="currentColor"
                  />
                </svg>
                <span>Total purchase costs</span>
              </div>
              <div class="mgc-accordion-value" id="mgc-totalCostsValue">
                0 AED
              </div>
            </button>
            <div class="mgc-accordion-body">
              <ul class="mgc-fees-list">
                <li>
                  <span>Land department fee</span
                  ><span id="mgc-landDeptValue">0 AED</span>
                </li>
                <li>
                  <span>Registration trustee fee</span
                  ><span id="mgc-trusteeValue">0 AED</span>
                </li>
                <li>
                  <span>Mortgage registration fee</span
                  ><span id="mgc-mortgageRegValue">0 AED</span>
                </li>
                <li>
                  <span>Real estate agency fee</span
                  ><span id="mgc-agencyValue">0 AED</span>
                </li>
                <li>
                  <span>Bank arrangement fee</span
                  ><span id="mgc-bankValue">0 AED</span>
                </li>
                <li>
                  <span>Mortgage valuation fee</span
                  ><span id="mgc-valuationValue">0 AED</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="mgc-modal-footer">
          <button class="mgc-btn-outline" id="mgc-closeCostsBtn2" type="button">
            Close
          </button>
          <button class="mgc-btn" type="button" id="mgc-proceedBtn">
            Proceed
          </button>
        </div>
      </div>
    </div>

    <script>
      // Centralized limits and residency rules (tweakable to match source site)
      const LIMITS = {
        purchasePrice: { min: 300000, max: 200000000, step: 10000 },
        period: { min: 1, max: 25, step: 1 },
        rate: { min: 1, max: 10, step: 0.01 },
        threshold: 5000000,
        residency: {
          uaeNational: { dpUnder: 0.15, dpOver: 0.25, loanMinPercent: 0.15 },
          uaeResident: { dpUnder: 0.2, dpOver: 0.3, loanMinPercent: 0.2 },
          nonResident: { dpUnder: 0.25, dpOver: 0.35, loanMinPercent: 0.25 },
        },
      };
      let activeResidency = "uaeResident"; // default selected in UI
      const purchasePrice = document.getElementById("mgc-purchasePrice");
      const downPayment = document.getElementById("mgc-downPayment");
      const loanAmount = document.getElementById("mgc-loanAmount");
      const loanPeriod = document.getElementById("mgc-loanPeriod");
      const interestRate = document.getElementById("mgc-interestRate");
      const monthlyPayment = document.getElementById("mgc-monthlyPayment");

      // Text inputs
      const purchasePriceInput = document.getElementById(
        "mgc-purchasePriceInput"
      );
      const downPaymentInput = document.getElementById("mgc-downPaymentInput");
      const loanAmountInput = document.getElementById("mgc-loanAmountInput");
      const loanPeriodInput = document.getElementById("mgc-loanPeriodInput");
      const interestRateInput = document.getElementById(
        "mgc-interestRateInput"
      );

      // Dynamic labels and badges
      const rateDisplay = document.getElementById("mgc-rateDisplay");
      const downPercent = document.getElementById("mgc-downPercent");
      const loanPercent = document.getElementById("mgc-loanPercent");
      const purchaseMinLabel = document.getElementById("mgc-purchaseMinLabel");
      const purchaseMaxLabel = document.getElementById("mgc-purchaseMaxLabel");
      const downMinLabel = document.getElementById("mgc-downMinLabel");
      const downMaxLabel = document.getElementById("mgc-downMaxLabel");
      const loanMinLabel = document.getElementById("mgc-loanMinLabel");
      const loanMaxLabel = document.getElementById("mgc-loanMaxLabel");

      function format(num) {
        const n = Number(num);
        if (isNaN(n)) return "0";
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
      function parseNum(v) {
        return parseFloat(String(v).replace(/[^0-9.]/g, "")) || 0;
      }
      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v));
      }

      function roundToStep(value, step) {
        return Math.round(value / step) * step;
      }

      // Paint a filled track for the slider based on value
      function setRangeFill(rangeEl) {
        const min = parseFloat(rangeEl.min || 0);
        const max = parseFloat(rangeEl.max || 1);
        const val = parseFloat(rangeEl.value || 0);
        let pct = max === min ? 0 : ((val - min) / (max - min)) * 100;
        pct = Math.max(0, Math.min(100, pct));
        const p = pct.toFixed(2);
        rangeEl.style.backgroundImage = `linear-gradient(to right, var(--primary) 0%, var(--primary) ${p}%, #e9e5f4 ${p}%, #e9e5f4 100%)`;
      }

      function calculateMonthlyPayment() {
        const P = parseFloat(loanAmount.value);
        const r = parseFloat(interestRate.value) / 100 / 12;
        const n = parseInt(loanPeriod.value) * 12;
        const m = r === 0 ? P / n : (P * r) / (1 - Math.pow(1 + r, -n));
        monthlyPayment.innerText = format(m.toFixed(0)) + " AED";
      }

      function syncDownLoan() {
        const total = parseFloat(purchasePrice.value);
        // Respect dynamic min/max derived by applyConstraints
        const dpMin = parseFloat(downPayment.min) || 0;
        const dpMax = parseFloat(downPayment.max) || total;
        let dp = clamp(parseFloat(downPayment.value) || 0, dpMin, dpMax);
        let la = total - dp;
        const loanMin = parseFloat(loanAmount.min) || 0;
        const loanMax = parseFloat(loanAmount.max) || total;
        if (la < loanMin) {
          la = loanMin;
          dp = total - la;
        }
        if (la > loanMax) {
          la = loanMax;
          dp = total - la;
        }
        // Round to step to avoid tiny drifts
        dp = roundToStep(dp, LIMITS.purchasePrice.step);
        la = roundToStep(la, LIMITS.purchasePrice.step);
        downPayment.value = dp;
        loanAmount.value = la;

        const dpPercentVal = total > 0 ? Math.round((dp / total) * 100) : 0;
        const laPercentVal = 100 - dpPercentVal;

        downPercent.innerText = dpPercentVal;
        loanPercent.innerText = laPercentVal;

        // mirror to text inputs
        downPaymentInput.value = format(dp);
        loanAmountInput.value = format(la);
      }

      function updateSliderLabels() {
        purchaseMinLabel.innerText = format(purchasePrice.min) + " AED";
        purchaseMaxLabel.innerText = format(purchasePrice.max) + " AED";
        downMinLabel.innerText = format(downPayment.min) + " AED";
        downMaxLabel.innerText = format(downPayment.max) + " AED";
        loanMinLabel.innerText = format(loanAmount.min) + " AED";
        loanMaxLabel.innerText = format(loanAmount.max) + " AED";
      }

      function residencyRules(price) {
        const cfg = LIMITS.residency[activeResidency];
        const dpPct = price <= LIMITS.threshold ? cfg.dpUnder : cfg.dpOver;
        const ltvCap = 1 - dpPct; // max you can borrow
        const loanMinPct = cfg.loanMinPercent;
        return { dpPct, ltvCap, loanMinPct };
      }

      function applyConstraints() {
        // Base bounds
        purchasePrice.min = LIMITS.purchasePrice.min;
        purchasePrice.max = LIMITS.purchasePrice.max;
        purchasePrice.step = LIMITS.purchasePrice.step;
        loanPeriod.min = LIMITS.period.min;
        loanPeriod.max = LIMITS.period.max;
        interestRate.min = LIMITS.rate.min;
        interestRate.max = LIMITS.rate.max;

        const price = clamp(
          parseFloat(purchasePrice.value) || LIMITS.purchasePrice.min,
          LIMITS.purchasePrice.min,
          LIMITS.purchasePrice.max
        );
        const { dpPct, ltvCap, loanMinPct } = residencyRules(price);

        let dpMin = roundToStep(price * dpPct, LIMITS.purchasePrice.step);
        const loanMin = roundToStep(
          price * loanMinPct,
          LIMITS.purchasePrice.step
        );
        const loanMax = roundToStep(price * ltvCap, LIMITS.purchasePrice.step);
        // Disallow DP values that eliminate the minimum loan
        let dpMax = roundToStep(price - loanMin, LIMITS.purchasePrice.step);
        if (dpMin > dpMax) dpMin = dpMax;

        downPayment.min = dpMin;
        downPayment.max = dpMax;
        loanAmount.min = Math.min(loanMin, loanMax);
        loanAmount.max = Math.max(loanMin, loanMax);

        // Keep sum consistent
        let dp = clamp(parseFloat(downPayment.value) || dpMin, dpMin, dpMax);
        let la = price - dp;
        if (la < loanAmount.min) {
          la = loanAmount.min;
          dp = price - la;
        }
        if (la > loanAmount.max) {
          la = loanAmount.max;
          dp = price - la;
        }
        downPayment.value = roundToStep(dp, LIMITS.purchasePrice.step);
        loanAmount.value = roundToStep(la, LIMITS.purchasePrice.step);

        updateSliderLabels();
        [
          purchasePrice,
          downPayment,
          loanAmount,
          loanPeriod,
          interestRate,
        ].forEach(setRangeFill);
      }

      function updateAll() {
        // Reflect slider values to inputs
        purchasePriceInput.value = format(purchasePrice.value);
        applyConstraints();
        updateSliderLabels();

        interestRateInput.value = String(parseFloat(interestRate.value));
        loanPeriodInput.value = String(parseInt(loanPeriod.value));
        rateDisplay.innerText = parseFloat(interestRate.value).toFixed(2) + "%";
        syncDownLoan();
        calculateMonthlyPayment();
        updateModalFigures();
        [
          purchasePrice,
          downPayment,
          loanAmount,
          loanPeriod,
          interestRate,
        ].forEach(setRangeFill);
      }

      // Slider -> UI
      purchasePrice.addEventListener("input", updateAll);
      downPayment.addEventListener("input", () => {
        syncDownLoan();
        calculateMonthlyPayment();
        setRangeFill(downPayment);
        // Coupled slider also changes (loan = price - dp)
        setRangeFill(loanAmount);
      });
      loanAmount.addEventListener("input", () => {
        const total = parseFloat(purchasePrice.value);
        const la = clamp(
          parseFloat(loanAmount.value),
          parseFloat(loanAmount.min),
          Math.min(parseFloat(loanAmount.max), total)
        );
        loanAmount.value = la;
        const dp = total - la;
        downPayment.value = dp;
        syncDownLoan();
        calculateMonthlyPayment();
        setRangeFill(loanAmount);
        // Coupled slider also changes (dp = price - loan)
        setRangeFill(downPayment);
      });
      [loanPeriod, interestRate].forEach((el) =>
        el.addEventListener("input", updateAll)
      );
      // Ensure fills repaint on change (keyboard, touch-release)
      [
        purchasePrice,
        loanPeriod,
        interestRate,
        downPayment,
        loanAmount,
      ].forEach((el) => el.addEventListener("change", () => setRangeFill(el)));

      // Text input -> Sliders
      purchasePriceInput.addEventListener("input", () => {
        const v = clamp(
          parseNum(purchasePriceInput.value),
          parseFloat(purchasePrice.min),
          parseFloat(purchasePrice.max)
        );
        purchasePrice.value = v;
        updateAll();
      });
      downPaymentInput.addEventListener("input", () => {
        const min = parseFloat(downPayment.min);
        const max = parseFloat(downPayment.max);
        const v = clamp(parseNum(downPaymentInput.value), min, max);
        downPayment.value = v;
        syncDownLoan();
        calculateMonthlyPayment();
        setRangeFill(downPayment);
        setRangeFill(loanAmount);
      });
      loanAmountInput.addEventListener("input", () => {
        const min = parseFloat(loanAmount.min);
        const max = parseFloat(loanAmount.max);
        const v = clamp(parseNum(loanAmountInput.value), min, max);
        loanAmount.value = v;
        const total = parseFloat(purchasePrice.value);
        downPayment.value = total - v;
        syncDownLoan();
        calculateMonthlyPayment();
        setRangeFill(loanAmount);
        setRangeFill(downPayment);
      });
      loanPeriodInput.addEventListener("input", () => {
        const v = clamp(
          parseInt(parseNum(loanPeriodInput.value) || 0),
          parseInt(loanPeriod.min),
          parseInt(loanPeriod.max)
        );
        loanPeriod.value = v;
        updateAll();
      });
      interestRateInput.addEventListener("input", () => {
        const v = clamp(
          parseNum(interestRateInput.value),
          parseFloat(interestRate.min),
          parseFloat(interestRate.max)
        );
        interestRate.value = v;
        updateAll();
      });

      // Residency status toggle
      document.querySelectorAll(".mgc-residency button").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".mgc-residency button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          if (btn.id === "mgc-uaeNational") activeResidency = "uaeNational";
          if (btn.id === "mgc-uaeResident") activeResidency = "uaeResident";
          if (btn.id === "mgc-nonResident") activeResidency = "nonResident";
          updateAll();
        });
      });

      // Upfront costs modal logic
      const costsModal = document.getElementById("mgc-costsModal");
      const viewCostsBtn = document.getElementById("mgc-viewCostsBtn");
      const closeBtns = [
        document.getElementById("mgc-closeCostsBtn"),
        document.getElementById("mgc-closeCostsBtn2"),
      ];
      const costsAccordion = document.getElementById("mgc-costsAccordion");

      function currency(n) {
        return format(Math.round(n)) + " AED";
      }
      function calcFees() {
        const price = parseFloat(purchasePrice.value) || 0;
        const loan = parseFloat(loanAmount.value) || 0;
        const dp = parseFloat(downPayment.value) || 0;
        const landDept = price * 0.04 + 580; // 4% + admin
        const trustee = price > 500000 ? 4200 : 2100; // threshold rule
        const mortgageReg = loan * 0.0025 + 290; // 0.25% + admin
        const agency = price * 0.02 * 1.05; // 2% + 5% VAT
        const bank = loan * 0.005 * 1.05; // 0.5% + 5% VAT
        const valuation = 3150; // fixed
        const total =
          landDept + trustee + mortgageReg + agency + bank + valuation;
        return {
          dp,
          landDept,
          trustee,
          mortgageReg,
          agency,
          bank,
          valuation,
          total,
        };
      }
      function updateModalFigures() {
        const f = calcFees();
        const set = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = currency(val);
        };
        set("mgc-dpRowValue", f.dp);
        set("mgc-totalCostsValue", f.total);
        set("mgc-landDeptValue", f.landDept);
        set("mgc-trusteeValue", f.trustee);
        set("mgc-mortgageRegValue", f.mortgageReg);
        set("mgc-agencyValue", f.agency);
        set("mgc-bankValue", f.bank);
        set("mgc-valuationValue", f.valuation);
      }
      function openModal() {
        costsModal.classList.add("open");
        costsModal.setAttribute("aria-hidden", "false");
      }
      function closeModal() {
        costsModal.classList.remove("open");
        costsModal.setAttribute("aria-hidden", "true");
      }
      if (viewCostsBtn) {
        viewCostsBtn.addEventListener("click", () => {
          updateModalFigures();
          openModal();
        });
      }
      closeBtns.forEach((b) => b && b.addEventListener("click", closeModal));
      costsModal?.addEventListener("click", (e) => {
        if (e.target === costsModal) closeModal();
      });
      costsAccordion
        ?.querySelector(".mgc-accordion-header")
        ?.addEventListener("click", () => {
          costsAccordion.classList.toggle("open");
        });

      // Initialize International Telephone Input (v25)
      const __initITI = () => {
        const phoneEl = document.querySelector("#mgc-phone");
        if (phoneEl && window.intlTelInput && !window.__iti) {
          window.__iti = window.intlTelInput(phoneEl, {
            initialCountry: "ae",
            nationalMode: false,
            separateDialCode: true,
            preferredCountries: [
              "ae",
              "sa",
              "om",
              "qa",
              "kw",
              "bh",
              "eg",
              "gb",
              "us",
              "in",
            ],
            loadUtils: () =>
              import(
                "https://cdn.jsdelivr.net/npm/intl-tel-input@25.12.3/build/js/utils.js"
              ),
          });
        }
      };
      document.addEventListener("DOMContentLoaded", __initITI);
      window.addEventListener("load", __initITI);

      updateAll();

      // Form submission: log and alert labels with values
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("mgc-form");
        form?.addEventListener("submit", (e) => {
          e.preventDefault();
          const values = [
            ["Purchase Price", purchasePriceInput.value + " AED"],
            [
              "Down Payment",
              downPaymentInput.value +
                " AED (" +
                downPercent.textContent +
                "%)",
            ],
            [
              "Loan Amount",
              loanAmountInput.value + " AED (" + loanPercent.textContent + "%)",
            ],
            ["Loan Period", loanPeriodInput.value + " years"],
            [
              "Interest Rate",
              parseFloat(interestRateInput.value).toFixed(2) + "%",
            ],
            ["Name", document.getElementById("mgc-name").value],
            ["Email", document.getElementById("mgc-email").value],
            [
              "Phone",
              window.__iti
                ? window.__iti.getNumber()
                : document.getElementById("mgc-phone").value,
            ],
          ];
          const message = values.map(([k, v]) => `${k}: ${v}`).join("\n");
          console.log("Form submission:\n" + message);
          alert(message);
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@25.12.3/build/js/intlTelInput.min.js"></script>
  </body>
</html>
